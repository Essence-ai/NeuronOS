# NeuronOS Post-Install Setup Module
# Configures services and creates default VM network
---
dontChroot: false
timeout: 300

script:
  # Enable NetworkManager
  - command: "systemctl enable NetworkManager.service"

  # Enable GDM (display manager)
  - command: "systemctl enable gdm.service"

  # Enable Bluetooth
  - command: "systemctl enable bluetooth.service"

  # Create Looking Glass shared memory configuration
  - command: |
      cat > /etc/tmpfiles.d/10-looking-glass.conf << 'EOF'
      f /dev/shm/looking-glass 0660 @@USER@@ kvm -
      EOF
    timeout: 10

  # Configure Flatpak remotes
  - command: "flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo"
    timeout: 60

  # Create default libvirt network
  - command: |
      cat > /etc/libvirt/qemu/networks/default.xml << 'EOF'
      <network>
        <name>default</name>
        <forward mode='nat'>
          <nat>
            <port start='1024' end='65535'/>
          </nat>
        </forward>
        <bridge name='virbr0' stp='on' delay='0'/>
        <ip address='192.168.122.1' netmask='255.255.255.0'>
          <dhcp>
            <range start='192.168.122.2' end='192.168.122.254'/>
          </dhcp>
        </ip>
      </network>
      EOF
    timeout: 10

  # Create NeuronOS config directory
  - command: "mkdir -p /etc/neuron-os"

  # Create default configuration
  - command: |
      cat > /etc/neuron-os/config.yaml << 'EOF'
      # NeuronOS Configuration
      version: "1.0"

      vm:
        default_memory_mb: 8192
        default_cpus: 4
        storage_path: "/var/lib/neuron-os/vms"
        iso_path: "/var/lib/neuron-os/iso"

      looking_glass:
        enabled: true
        shmem_size_mb: 128

      usb:
        auto_passthrough: true
        excluded_devices: []

      wine:
        prefix_path: "~/.wine"
        default_version: "system"
      EOF
    timeout: 10

  # Create VM storage directories
  - command: "mkdir -p /var/lib/neuron-os/{vms,iso,snapshots}"

  # Set permissions
  - command: "chown -R @@USER@@:@@USER@@ /var/lib/neuron-os"

  # Create desktop shortcut for NeuronOS Welcome
  - command: |
      cat > /home/@@USER@@/.config/autostart/neuron-welcome.desktop << 'EOF'
      [Desktop Entry]
      Type=Application
      Name=NeuronOS Welcome
      Exec=/usr/bin/neuron-welcome
      Icon=neuron-os
      Terminal=false
      Categories=System;
      EOF
    timeout: 10
