# NeuronOS VFIO Setup Module
# Runs after base installation to configure VFIO passthrough
---
dontChroot: false
timeout: 300

script:
  # Detect hardware and generate VFIO configuration
  - command: "/usr/bin/neuron-hardware-detect config --auto --target @@ROOT@@"
    timeout: 120

  # Enable virtualization services
  - command: "systemctl enable libvirtd.service"
  - command: "systemctl enable virtlogd.socket"

  # Add user to virtualization groups
  - command: "usermod -aG libvirt,kvm,input @@USER@@"

  # Configure IOMMU in bootloader if supported
  - command: |
      if grep -q "Intel" /proc/cpuinfo; then
        sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="intel_iommu=on iommu=pt /' /etc/default/grub
      elif grep -q "AMD" /proc/cpuinfo; then
        sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/GRUB_CMDLINE_LINUX_DEFAULT="amd_iommu=on iommu=pt /' /etc/default/grub
      fi
    timeout: 30

  # Regenerate GRUB config
  - command: "grub-mkconfig -o /boot/grub/grub.cfg"
    timeout: 60

  # Regenerate initramfs with VFIO modules
  - command: "mkinitcpio -P"
    timeout: 120
