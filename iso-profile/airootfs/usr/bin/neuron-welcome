#!/bin/bash
# NeuronOS Welcome Script - Shows welcome dialog with theme selection on live boot

# Theme selection dialog
THEME=$(zenity --list \
    --title="Choose Your Style" \
    --text="Welcome to NeuronOS!\n\nSelect your preferred visual style:" \
    --radiolist \
    --column="Select" --column="Theme" --column="Description" \
    TRUE "Neural" "Future-minimalist with deep space aesthetics (Default)" \
    FALSE "Clarity" "Clean, productivity-focused with familiar layouts" \
    FALSE "Frost" "Premium translucency for creative professionals" \
    --width=500 \
    --height=350)

# Apply selected theme
if [ -n "$THEME" ]; then
    case "$THEME" in
        "Neural")
            THEME_FILE="neuron.css"
            ;;
        "Clarity")
            THEME_FILE="win11.css"
            ;;
        "Frost")
            THEME_FILE="macos.css"
            ;;
    esac
    
    # Set the theme as default for the user
    mkdir -p ~/.config/neuron-os
    echo "$THEME_FILE" > ~/.config/neuron-os/selected-theme
    
    # Copy theme to GTK4 user config
    mkdir -p ~/.config/gtk-4.0
    if [ -f "/usr/share/neuron-os/themes/$THEME_FILE" ]; then
        cp "/usr/share/neuron-os/themes/$THEME_FILE" ~/.config/gtk-4.0/gtk.css
    fi
    
    zenity --info \
        --title="Theme Applied" \
        --text="$THEME theme has been applied!\n\nYou can change this later in Settings." \
        --width=300
fi

# Installation prompt
zenity --question \
    --title="Install NeuronOS" \
    --text="Would you like to install NeuronOS to your system now?\n\nYou can also click 'Install NeuronOS' on the desktop later." \
    --ok-label="Install Now" \
    --cancel-label="Try Live Session" \
    --width=400

if [ $? -eq 0 ]; then
    # Launch Calamares installer if available, otherwise archinstall
    if command -v calamares &> /dev/null; then
        pkexec calamares &
    else
        # Refresh keys to prevent installation errors
        gnome-terminal -- bash -c "echo 'Initializing package keys...' && sudo pacman-key --init && sudo pacman-key --populate archlinux && sudo pacman -Sy --noconfirm archlinux-keyring && sudo archinstall; echo 'Installer finished. Press Enter to close.'; read" &
    fi
fi
