#!/usr/bin/env python3
"""
NeuronStore - Entry point
Application store with intelligent routing (Native/Wine/VM)
"""

import sys
sys.path.insert(0, '/usr/lib/neuron-os')

def main():
    # Try Qt GUI first (for LXQt desktop)
    try:
        from PyQt6.QtWidgets import QApplication
        from store.gui.store_window_qt import main as qt_main
        return qt_main()
    except ImportError as e:
        print(f"Qt GUI unavailable: {e}")

    # Fallback to GTK GUI
    try:
        import gi
        gi.require_version('Gtk', '4.0')
        gi.require_version('Adw', '1')
        from gi.repository import Gtk, Adw
        from store.gui.store_window import main as gtk_main
        return gtk_main()
    except (ImportError, ValueError) as e:
        print(f"GTK GUI unavailable: {e}")
        print("Falling back to CLI mode...")

    # CLI mode fallback
    import argparse
    from store.app_catalog import AppCatalog, CompatibilityLayer

    parser = argparse.ArgumentParser(description='NeuronStore - Application Catalog')
    parser.add_argument('--search', '-s', type=str, help='Search for apps')
    parser.add_argument('--list', '-l', action='store_true', help='List all apps')
    parser.add_argument('--native', action='store_true', help='Show only native apps')
    parser.add_argument('--wine', action='store_true', help='Show Wine-compatible apps')
    parser.add_argument('--vm', action='store_true', help='Show apps requiring VM')

    args = parser.parse_args()

    catalog = AppCatalog()
    if not catalog.load():
        print("Warning: Could not load app catalog")
        return 1

    if args.search:
        results = catalog.search(args.search)
        print(f"\nSearch results for '{args.search}':")
        for app in results:
            layer_icon = {
                CompatibilityLayer.NATIVE: "Native",
                CompatibilityLayer.WINE: "Wine",
                CompatibilityLayer.PROTON: "Proton",
                CompatibilityLayer.VM_WINDOWS: "Windows VM",
                CompatibilityLayer.VM_MACOS: "macOS VM",
                CompatibilityLayer.FLATPAK: "Flatpak",
            }.get(app.layer, "?")
            print(f"  [{layer_icon}] {app.name} - {app.description[:50]}...")

    elif args.list or args.native or args.wine or args.vm:
        if args.native:
            apps = catalog.native_apps()
            print("\nNative Linux Apps:")
        elif args.wine:
            apps = catalog.wine_apps()
            print("\nWine-Compatible Apps:")
        elif args.vm:
            apps = catalog.vm_required_apps()
            print("\nApps Requiring VM:")
        else:
            apps = catalog.all()
            print("\nAll Apps in Catalog:")

        for app in apps:
            print(f"  - {app.name}: {app.description[:60]}...")

    else:
        parser.print_help()
        print("\n" + "=" * 50)
        print(f"NeuronStore: {len(catalog.all())} apps in catalog")
        print(f"  Native: {len(catalog.native_apps())}")
        print(f"  Wine/Proton: {len(catalog.wine_apps())}")
        print(f"  Requires VM: {len(catalog.vm_required_apps())}")

    return 0


if __name__ == '__main__':
    sys.exit(main())
